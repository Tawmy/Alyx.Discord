@inject ISender Sender
@inject NavigationManager NavManager
@page "/character/{lodestoneId}"
@using Alyx.Discord.Core.Requests.Character.Sheet
@using MediatR
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.Formats.Webp

@if (LodestoneId is not null && _characterSheetResponse is not null)
{
    <HeadContent>
        <meta property="og:title"
              content="@_characterSheetResponse.Character.Name (@_characterSheetResponse.Character.Server)"/>
        <meta property="og:image" content="@(NavManager.BaseUri)api/sheet/@LodestoneId"/>
        <meta property="og:image:width" content="1193"/>
        <meta property="og:image:height" content="895"/>
        <meta property="og:image:type" content="image/webp"/>
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:image:src" content="@(NavManager.BaseUri)api/sheet/@LodestoneId">
    </HeadContent>
}

@if (_imageSource is not null)
{
    <img src="@_imageSource" alt="Character Sheet"/>
}

@code {
    [Parameter] public string? LodestoneId { get; set; }
    private CharacterSheetResponse? _characterSheetResponse;
    private string? _imageSource;

    protected override async Task OnInitializedAsync()
    {
        if (LodestoneId is null)
        {
            return;
        }

        _characterSheetResponse = await Sender.Send(new CharacterSheetRequest(LodestoneId, false));
        var image = _characterSheetResponse.Image;
        _imageSource = image.ToBase64String(WebpFormat.Instance);
    }

}